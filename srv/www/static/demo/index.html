<!doctype html>
<html>
<head>
    <script src="jquery.min.js"></script>
    <title>Ads</title>
    <style>
    body, div, span, a {
        font-family: Arial, Helvetica, sans-serif;
    }
    .circle {
        border-radius: 50%;
        background-color: black;
        color: white;
        padding-left:4px;
        padding-right:4px;
        font-weight: 100;
    }
    </style>
</head>
<body style="background-color:#fff">

<!-- begin bidx_export -->
<div class="bidx_export">

<div style="padding:0.5em; background-color:inherit; width:710px">
<div>
    <img src="catalog.jpg">
</div>
<div style="font-family:sans-serif; text-align:left">

<span class="circle">1</span> Christopher Kane striped-detail cotton sweatshirt,
<span id="a0" class="bidx">
  <span class="price">$444</span>;
  <span class="site"><a href="http://www.brownsfashion.com/">brownsfashion.com</a></span>
</span>

<span class="circle">2</span> Rag &amp; Bone Boyfriend jean,
<span id="a1" class="bidx">
  <span class="price">$220</span>;
  <span class="site"><a href="http://www.lagarconne.com/">lagarconne.com</a></span>
</span>

<span class="circle">3</span> MAC Cosmetics Eye Kohl in Powersurgem
<span id="a2" class="bidx">
  <span class="price">$16</span>;
  <span class="site"><a href="http://www.maccosmetics.com/">maccosmetics.com</a></span>
</span>

<span class="circle">4</span> Clare Vivier Foldover clutch,
<span id="a3" class="bidx">
  <span class="price">$185</span>;
  <span class="site"><a href="http://www.stevenalan.com/">stevenalan.com</a></span>
</span>

<span class="circle">5</span> Vans Authentic Lo Pro Sneaker;
<span id="a4" class="bidx">
  <span class="price">$45</span>;
  <span class="site"><a href="http://www.nordstrom.com/">nordstrom.com</a></span>
</span>

<span class="circle">6</span> Balenciaga golden thick tube ring set,
<span id="a5" class="bidx">
  <span class="price">$765</span>;
  <span class="site"><a href="http://www.barneys.com/">barneys.com</a></span>
</span>

</div>
</div>

</div>
<!-- end bidx_export -->

<script>

var bidx = {

    init: function()
    {
        return true;
    },

    bid_url: function(price)
    {
        return 'http://bidx.co/bid/?price='+price+'&t='+Date.now();
    },

    on_bid_response: function(span, msg)
    {
        if (msg.hasOwnProperty('id')) {
            var price = msg['price'];
            var vendor = msg['id'];
            var link = 'http://www.' + msg['id'] + '/';
            console.log(span, price, msg, link);
            $('span#'+span+' span.price').text('$'+Math.round(price));
            $('span#'+span+' span.site a').attr('href', link);
            $('span#'+span+' span.site a').text(vendor);
        }
    },

    bid: function(span)
    {
        var price = $('span#'+span+' span.price').text().substr(1);
        var jqxhr = $.ajax({
            url: bidx.bid_url(price),
            dataType: 'json',
            timeout: 3000
        })
        .done(function(msg) { on_bid_response(span, msg); })
        .fail(function() { console.log("error"); })
        .always(function() { $('span#'+span).show('slow'); });
    },

    run: function()
    {
        var biddable = document.getElementsByClassName('bidx');
        for (var i = 0; i < biddable.length; i++) {
            var span = biddable[i].attributes["id"].value;
            console.log(span);
            $('span#'+span).hide() // TODO: remove dependence on jQuery
            setTimeout(function(span) {
                return function() {
                    bidx.bid(span)
                }
            }(span), 500*i);
        }
    }
};

$(document).ready(function() {
    bidx.init();
    bidx.run();
});
</script>

</body>
</html>
